# Instructions to run AMUND_ICE

Its suggested you have a directory tree in /work/..... (Not /home/..., as this is not usable from a batch job) of the form:
- ./Singularity
- ./eCSE-archer2-AmundIce
- ./eCSE-archer2-AmundIce/.git
- ./eCSE-archer2-AmundIce/scripts_ecse
- ./eCSE-archer2-AmundIce/code_ecse
- ./eCSE-archer2-AmundIce/input_ecse
- ./MITgcm


# Downloads
Download MITgcm and then the Singularity container for OpenAd and this github:
- Create directory ./MITgcm and cd into it then
>  git clone git@github.com:dngoldberg/MITgcm.git 
- Create directory ./Singularity and cd into it then
>  singularity pull library://jahn/default/openad:latest


 Download/copy files
> git clone git@github.com:eCSE-MITgcm-ARCHER2/eCSE-archer2-AmundIce.git
   The directories 
-    input_ecse
-    code_ecse
-    scripts_ecse
   will be cloned into a local repository.

# Environment
 - Set the environment variables in scripts_ecse/case_setup, a script used to have a unique place to set your environment for making and for runs.
 - Set the environment variable MITGCM_ROOTDIR to the location of your MITgcm source (so, e.g. tools is s subdirectory there).
 - update "make_archer.sh" with locations of OpenAD singularity image and PETSc installation

# SET UP A CASE
To give flexibility to change either the scripts/code used by all your runs (in ecse...) or just the  files for a  specific case...
Create a "case" directory: it will have subdirectories
. ./scripts  A copy of scripts_ecse edited for this case
. ./build where the executable is built
. ./run where the run is made.
. ./code A copy of the code used.
e.g. when running a test with 90 cores and O3 optimisation: 
> mkdir -p  ./cases/90/O3 
> cp -r ./eCSE-archer2-AmundIce/scripts_ecse ./cases/90/O3/scripts
The code, build and run directories are generated by scripts below.
One of the consequences of arrangin this is that there remians a record of exactly what was used in a case, so subsequent changes to the eccse-scripts directory dotn affect the record of waht a case actually used.

# BUILD THE EXECUTABLE.

- change to the case's scripts directory.
- run the "make_archer.sh" script. (The build should require ~15 minutes)


# SUBMIT THE EXECUTABLE.

-  run the script "submit_ad.sh". (The script should run on 90 cpus on a single node, and should last approx runtime 4-5 hours)

# MAKING CHANGES
## THE NUMBER OF CPUs

To modify the cpu count, 2 changes must be made:
- the SLURM header of scripts/run.slurm should be changed to reflect nodes and cpus per node (currently 1 and 90, resp)
- sNx (sNy) and nPx (nPy) of code/SIZE.h should be modified, such that the products sNx*nPx and sNy*nPy remain constant. Executable must be rebuilt.

## TURN OFF USE OF PETSC
After creating the run directory, data.streamice set "streamice_use_petsc = .false.". No recompilation is necessary.

## SET A DIFFERENT RUN TIME

 currently the model does a 20-year simulation with 240 1-month time steps. To modify this change "nTimeSteps" within input_ecse/data. 
